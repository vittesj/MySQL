# Курсовая работа по базам данных

База данных YTDB разработана как упрощённая модель хранения данных сайта YouTube.

Основная задача базы данных - обеспечить удобное и надёжное хранение данных сайта. Информация в базе данных должна быть правильно структурирована для возможности дальнейшей выборки, сортировки и обработки.

Основные сущности - пользователи (***users***), видео-ролики (***videos***) и каналы пользователей (***channels***). Их дополняет множество других сущностей - плейлисты (***playlists***), страны (***countries***), публикации или посты (***posts***), просмотры (***video_views*** и ***post_views***), хештеги (***tags***), комментарии (***video_comments*** и ***post_comments***) и другие.

##### Пользователи

Пользователи могут просматривать видео-ролики и публикации каналов других пользователей, ставить отметки "лайк" или "дизлайк" к видео-роликам и постам, могут подписываться на каналы других пользователей, не создавая свой канал.

У пользователя, создавшего свой канал, появляется возможность загружать свои видео-ролики на сайт, оставлять комментарии к видео-роликам и постам и ставить отметки "лайк" или "дизлайк" к комментариям других пользователей.

Основная информация о пользователях и их регистрационные данные содержатся в таблицах ***users*** и ***user_info***.  
Информация о подписках отражается в таблице ***subscriptions***.

##### Каналы

На своём канале пользователь может загружать видео-ролики, при желании для удобства просмотра группировать их в плейлисты, может публиковать посты (информацию, содержащую текст и/или картинки).

Основная информация о каналах отображается в таблице ***channels***. Данные о плейлистах - в таблицах ***playlists*** и ***playlist_videos***.  
Информация о постах (публикациях), об их просмотрах пользователями и отметках находится в таблицах ***posts*** и ***post_views***.

##### Видео-ролики

Видео-ролик загружается пользователем на его канал, имеет название, длительность, может быть в открытом доступе для просмотра или доступен по ссылке, либо может иметь статус *"удалён"*.

Основная информация о видео-роликах отображается в таблицах ***videos***, ***video_info*** и ***video_views***.  
Информация о видеороликах, отмеченных хештегами, находится в таблице ***video_tags***.

Комментарии пользователей к видео-роликам и постам, а также информация об отметках к комментариям хранится в таблицах ***video_comments***, ***post_comments***, ***votes_on_video_comments*** и ***votes_on_post_comments***.


## Представления

Представление - динамическая таблица, служащая для отображения результатов выборки информации из нескольких таблиц. Оно автоматически отражает изменения в базовых таблицах. С помощью представления можно ограничить доступ к остальной части информации из базовой таблицы.

Представления:

- Главная информация по видео (***v_video_profiles***)
    - id видео
    - название видео
    - канал, на который загружено видео
    - продолжительность видео
    - дата загрузки видео
    - количество просмотров данного видео
    - количество комментариев к видео
    - количество "лайков"
    - количество "дизлайков"
Соединение таблиц ***videos***, ***video_views***, ***video_comments***.

- Главная информация по каналам (***v_channel_profiles***)
    - id канала
    - название канала
    - дата создания канала
    - общее количество видео на канале
    - суммарная длительность всех видео
    - количество подписчиков канала
    - общее число просмотров всех видео канала
    - количество публикаций (постов) на канале
Соединение таблиц ***channels***, ***videos***, ***subscriptions***, ***posts*** и представления ***v_video_profiles***.

- Главная информация по пользователям и их активность (***v_user_profiles***)
    - id пользователя
    - имя пользователя (ник)
    - email
    - возраст
    - id страны пользователя
    - страна (название)
    - канал пользователя
    - количество подписок (каналов)
    - количество просмотров видео данным пользователем
    - количество комментариев к видео
    - количество голосов ("лайков" и "дизлайков") за видео
    - количество комментариев к постам
    - количество голосов за посты
    - голоса за комментарии других польз-лей к видео
    - голоса за комментарии других польз-лей к постам
Соединение таблиц ***users***, ***user_info***, ***countries***, ***channels***, ***subscriptions***, ***video_views***, ***video_comments***, ***post_comments***, ***post_views***, ***votes_on_video_comments***, ***votes_on_post_comments***.

- Информация по хештегам (***v_tags_and_videos***)
    - id хештега
    - название хештега
    - количество всех видео по хештегу
    - количество просмотров всех видео (по хештегу)
Соединение таблиц ***tags***, ***video_tags*** и представления ***v_video_profiles***.


## Запросы

Наиболее эффективным и универсальным способом выборки данных из таблиц базы данных являются запросы SQL.
Запросы (выборки):

- Пользователи старше 20 лет, которые подписаны на более чем 4 канала

- Каналы, которые созданы не более 3 лет назад, на которых больше 2 видео, и у которых больше 2 подписчиков

- Пользователи из Франции (например), написавшие наибольшее количество комментариев ко всем видео

- Статистика по подписчикам каналов

- Распределение подписчиков канала по странам

- Видео и количество комментариев (по плейлистам)


## Хранимые процедуры

Хранимые процедуры облегчают выполнение одинаковых операций с базой данных на уровне приложения. Они размещаются на сервере базы данных, благодаря чему их вызов происходит быстрее. Хранимые процедуры можно независимо вызывать по мере необходимости из разных модулей приложения.

Хранимые процедуры:

- Подборка популярных видео-роликов ("в тренде") - видео-ролики (за 6 месяцев) с большим количеством просмотров, ещё не просмотренные пользователем

- Подборка видео-роликов, предлагаемых пользователю к просмотру (с канала, на который подписан пользователь)

- Подборка видео-роликов с наибольшим количеством просмотров по хештегу

- Запрос - определение главного хештега канала


## Триггеры

Триггеры - один или несколько SQL-операторов, которые автоматически запускаются сервером базы данных, когда происходит определённое событие.
Триггеры:

- **channels_ai** - триггер привязан к таблице ***channels***.
После вставки новой строки в таблицу ***channels*** (при создании нового канала) в таблице ***users*** автоматически происходит обновление: в строке, где *users.id* соответствует новому значению *channels.user_id* в поле столбца *users.user_channel* значение меняется на '1', в поле *users.updated_at* устанавливается текущая дата и время.

- **videos_ai** - триггер привязан к таблице ***videos***.
После вставки новой строки в таблицу ***videos*** (при загрузке нового видео-ролика на сайт) в таблице ***video_log*** автоматически происходит вставка строки с данными: id нового видео-ролика, заметка 'new_video' и текущая дата и время.

- **subscriptions_bd** - триггер привязан к таблице ***subscriptions***.
Перед удалением строки из таблицы ***subscriptions*** в таблицу ***subscription_log*** происходит вставка строки с данными: id пользователя из удаляемой записи, id канала из удаляемой записи, заметка 'deleted' и текущая дата и время.

